#!/bin/bash
# rapidget - Downloadmanager for rapidshare
# Author: Alexander Surma <surma@drebesium.org> - released under GPL

# Settings
COOKIEFILE="${HOME}/.rapidget"
LOGINURL="https://ssl.rapidshare.com/cgi-bin/premiumzone.cgi"

REAUTH=""
FILE=""
ACTFILE=""
URL=""
APPNAME=$(basename "${0}")
VERSION=2.0

version()
{
	echo "${APPNAME} v${VERSION}"
}

usage()
{
	version
	echo " [OPTIONS] <URL> [wget OPTIONS]"
	echo "Options:"
	echo "  -f		URL is a file containing a list of URLs rather than a single URL"
	echo "  -c PATH 	User this file instead of the default file for cookies (i.e. ~/.rapidget)"
	echo "  -u USER:PASS	Login using this data and save cookie to file"
	echo "  -v		Print version"
	echo "  -h		This message"
	mkill $@
}

cleanup()
{
	[ -n "${ACTFILE}" ] && rm -rf "${ACTFILE}"
}

mkill()
{
	cleanup
	exit ${1-1}
}

error()
{
	echo "${APPNAME}: ${1}" >&2
	mkill ${2} 
}

login()
{
	echo "Logging in..."
	NUM=$(wget -O - --post-data="login=${DATA[0]}&password=${DATA[1]}" \
		--save-cookies="${COOKIEFILE}" "${LOGINURL}" 2>/dev/null  \
		| grep -i 'Settings' \
		| wc -l)
	[ "${NUM}" -le 0 ] && error "Login incorrect"
}

trap mkill INT TERM

while getopts ":vhc:u:f" arg; do
	case "${arg}" in
		f) FILE="y" ;;
		c) COOKIEFILE="${OPTARG}" ;;
		u) DATA=($(echo ${OPTARG} | sed 's/:/ /')) ; REAUTH="y" ;;
		v) version ; mkill 0 ;;
		h) usage 0 ;;
		:) error "${OPTARG} requires an argument" ;;
		?) usage 1 ;;
	esac
done
shift $((${OPTIND} - 1))
URL="${1}"
shift
[ -z "${URL}" ] && usage 1

[ -n "${REAUTH}" ] && login
if [ -z "${FILE}" ]; then
	ACTFILE=$(basename "${URL}")
	wget -O "${ACTFILE}" $@ --load-cookies="${COOKIEFILE}" "${URL}"
else
	cat "${URL}" | while read LINE; do
		ACTFILE=$(basename "${LINE}")
		wget -O "${ACTFILE}" $@ --load-cookies="${COOKIEFILE}" "${LINE}" 
	done
fi
cleanup
